<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.5"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.5"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><title>Spring+MyBatis实现数据库读写分离方案 | Calm sea</title><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Spring+MyBatis实现数据库读写分离方案</h1><a id="logo" href="/.">Calm sea</a><p class="description">Whatever is worth doing is worth doing well.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Spring+MyBatis实现数据库读写分离方案</h1><div class="post-meta"><a href="/2017/08/15/java/MyBatis/Spring+MyBatis%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%96%B9%E6%A1%88/#comments" class="comment-count"></a><p><span class="date">Aug 15, 2017</span><span><a href="/categories/java-MyBatis/" class="category">java-MyBatis</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p> 推荐第四种：<a href="https://github.com/shawntime/shawn-rwdb" target="_blank" rel="noopener">https://github.com/shawntime/shawn-rwdb</a></p>
<h5 id="方案1"><a href="#方案1" class="headerlink" title="方案1"></a>方案1</h5><blockquote>
<p>通过MyBatis配置文件创建读写分离两个DataSource，每个SqlSessionFactoryBean对象的mapperLocations属性制定两个读写数据源的配置文件。将所有读的操作配置在读文件中，所有写的操作配置在写文件中。</p>
</blockquote>
<ul>
<li>优点：实现简单</li>
<li>缺点：维护麻烦，需要对原有的xml文件进行重新修改，不支持多读，不易扩展</li>
<li>实现方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id&#x3D;&quot;abstractDataSource&quot; abstract&#x3D;&quot;true&quot; class&#x3D;&quot;com.alibaba.druid.pool.DruidDataSource&quot; init-method&#x3D;&quot;init&quot;</span><br><span class="line">      destroy-method&#x3D;&quot;close&quot;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;driverClassName&quot; value&#x3D;&quot;com.microsoft.sqlserver.jdbc.SQLServerDriver&quot;&#x2F;&gt;</span><br><span class="line">    &lt;!-- 配置获取连接等待超时的时间 --&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;maxWait&quot; value&#x3D;&quot;60000&quot;&#x2F;&gt;</span><br><span class="line">    &lt;!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 --&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;timeBetweenEvictionRunsMillis&quot; value&#x3D;&quot;60000&quot;&#x2F;&gt;</span><br><span class="line">    &lt;!-- 配置一个连接在池中最小生存的时间，单位是毫秒 --&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;minEvictableIdleTimeMillis&quot; value&#x3D;&quot;300000&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;validationQuery&quot; value&#x3D;&quot;SELECT &#39;x&#39;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;testWhileIdle&quot; value&#x3D;&quot;true&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;testOnBorrow&quot; value&#x3D;&quot;false&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;testOnReturn&quot; value&#x3D;&quot;false&quot;&#x2F;&gt;</span><br><span class="line">    &lt;!-- 打开PSCache，并且指定每个连接上PSCache的大小 --&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;poolPreparedStatements&quot; value&#x3D;&quot;true&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;maxPoolPreparedStatementPerConnectionSize&quot; value&#x3D;&quot;20&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;filters&quot; value&#x3D;&quot;config&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;connectionProperties&quot; value&#x3D;&quot;config.decrypt&#x3D;true&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;bean id&#x3D;&quot;readDataSource&quot; parent&#x3D;&quot;abstractDataSource&quot;&gt;</span><br><span class="line">    &lt;!-- 基本属性 url、user、password --&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;read.jdbc.url&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;$&#123;read.jdbc.user&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;read.jdbc.password&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;!-- 配置初始化大小、最小、最大 --&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;initialSize&quot; value&#x3D;&quot;$&#123;read.jdbc.initPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;minIdle&quot; value&#x3D;&quot;10&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;maxActive&quot; value&#x3D;&quot;$&#123;read.jdbc.maxPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;bean id&#x3D;&quot;writeDataSource&quot; parent&#x3D;&quot;abstractDataSource&quot;&gt;</span><br><span class="line">    &lt;!-- 基本属性 url、user、password --&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;write.jdbc.url&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;$&#123;write.jdbc.user&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;write.jdbc.password&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;!-- 配置初始化大小、最小、最大 --&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;initialSize&quot; value&#x3D;&quot;$&#123;write.jdbc.initPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;minIdle&quot; value&#x3D;&quot;10&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;maxActive&quot; value&#x3D;&quot;$&#123;write.jdbc.maxPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;bean id&#x3D;&quot;readSqlSessionFactory&quot; class&#x3D;&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">    &lt;!-- 实例化sqlSessionFactory时需要使用上述配置好的数据源以及SQL映射文件 --&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;dataSource&quot; ref&#x3D;&quot;readDataSource&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;mapperLocations&quot; value&#x3D;&quot;classpath:mapper&#x2F;read&#x2F;*.xml&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;bean id&#x3D;&quot;writeSqlSessionFactory&quot; class&#x3D;&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">    &lt;!-- 实例化sqlSessionFactory时需要使用上述配置好的数据源以及SQL映射文件 --&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;dataSource&quot; ref&#x3D;&quot;writeDataSource&quot;&#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;mapperLocations&quot; value&#x3D;&quot;classpath:mapper&#x2F;write&#x2F;*.xml&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;bean&gt;</span><br></pre></td></tr></table></figure>

<h5 id="方案2"><a href="#方案2" class="headerlink" title="方案2"></a>方案2</h5><blockquote>
<p>通过Spring AOP在业务层实现读写分离，在DAO层调用前定义切面，利用Spring的AbstractRoutingDataSource解决多数据源的问题，实现动态选择数据源</p>
</blockquote>
<ul>
<li>优点：通过注解的方法在DAO每个方法上配置数据源，原有代码改动量少，易扩展，支持多读</li>
<li>缺点：需要在DAO每个方法上配置注解，人工管理，容易出错</li>
<li>实现方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;定义枚举类型，读写</span><br><span class="line">public enum DynamicDataSourceGlobal &#123;</span><br><span class="line">    READ, WRITE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import java.lang.annotation.ElementType;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * RUNTIME</span><br><span class="line"> * 定义注解</span><br><span class="line"> * 编译器将把注释记录在类文件中，在运行时 VM 将保留注释，因此可以反射性地读取。</span><br><span class="line"> * @author shma1664</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">public @interface DataSource &#123;</span><br><span class="line"></span><br><span class="line">    public DynamicDataSourceGlobal value() default DynamicDataSourceGlobal.READ;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Created by IDEA</span><br><span class="line"> * 本地线程设置和获取数据源信息</span><br><span class="line"> * User: mashaohua</span><br><span class="line"> * Date: 2016-07-07 13:35</span><br><span class="line"> * Desc:</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class DynamicDataSourceHolder &#123;</span><br><span class="line"></span><br><span class="line">    private static final ThreadLocal&lt;DynamicDataSourceGlobal&gt; holder &#x3D; new ThreadLocal&lt;DynamicDataSourceGlobal&gt;();</span><br><span class="line"></span><br><span class="line">    public static void putDataSource(DynamicDataSourceGlobal dataSource)&#123;</span><br><span class="line">        holder.set(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static DynamicDataSourceGlobal getDataSource()&#123;</span><br><span class="line">        return holder.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void clearDataSource() &#123;</span><br><span class="line">        holder.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.ThreadLocalRandom;</span><br><span class="line">import java.util.concurrent.atomic.AtomicLong;</span><br><span class="line">import java.util.concurrent.locks.Lock;</span><br><span class="line">import java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Created by IDEA</span><br><span class="line"> * User: mashaohua</span><br><span class="line"> * Date: 2016-07-14 10:56</span><br><span class="line"> * Desc: 动态数据源实现读写分离</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class DynamicDataSource extends AbstractRoutingDataSource &#123;</span><br><span class="line"></span><br><span class="line">    private Object writeDataSource; &#x2F;&#x2F;写数据源</span><br><span class="line"></span><br><span class="line">    private List&lt;Object&gt; readDataSources; &#x2F;&#x2F;多个读数据源</span><br><span class="line"></span><br><span class="line">    private int readDataSourceSize; &#x2F;&#x2F;读数据源个数</span><br><span class="line"></span><br><span class="line">    private int readDataSourcePollPattern &#x3D; 0; &#x2F;&#x2F;获取读数据源方式，0：随机，1：轮询</span><br><span class="line"></span><br><span class="line">    private AtomicLong counter &#x3D; new AtomicLong(0);</span><br><span class="line"></span><br><span class="line">    private static final Long MAX_POOL &#x3D; Long.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">    private final Lock lock &#x3D; new ReentrantLock();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void afterPropertiesSet() &#123;</span><br><span class="line">        if (this.writeDataSource &#x3D;&#x3D; null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;Property &#39;writeDataSource&#39; is required&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        setDefaultTargetDataSource(writeDataSource);</span><br><span class="line">        Map&lt;Object, Object&gt; targetDataSources &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">        targetDataSources.put(DynamicDataSourceGlobal.WRITE.name(), writeDataSource);</span><br><span class="line">        if (this.readDataSources &#x3D;&#x3D; null) &#123;</span><br><span class="line">            readDataSourceSize &#x3D; 0;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            for(int i&#x3D;0; i&lt;readDataSources.size(); i++) &#123;</span><br><span class="line">                targetDataSources.put(DynamicDataSourceGlobal.READ.name() + i, readDataSources.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">            readDataSourceSize &#x3D; readDataSources.size();</span><br><span class="line">        &#125;</span><br><span class="line">        setTargetDataSources(targetDataSources);</span><br><span class="line">        super.afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Object determineCurrentLookupKey() &#123;</span><br><span class="line"></span><br><span class="line">        DynamicDataSourceGlobal dynamicDataSourceGlobal &#x3D; DynamicDataSourceHolder.getDataSource();</span><br><span class="line"></span><br><span class="line">        if(dynamicDataSourceGlobal &#x3D;&#x3D; null</span><br><span class="line">                || dynamicDataSourceGlobal &#x3D;&#x3D; DynamicDataSourceGlobal.WRITE</span><br><span class="line">                || readDataSourceSize &lt;&#x3D; 0) &#123;</span><br><span class="line">            return DynamicDataSourceGlobal.WRITE.name();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int index &#x3D; 1;</span><br><span class="line"></span><br><span class="line">        if(readDataSourcePollPattern &#x3D;&#x3D; 1) &#123;</span><br><span class="line">            &#x2F;&#x2F;轮询方式</span><br><span class="line">            long currValue &#x3D; counter.incrementAndGet();</span><br><span class="line">            if((currValue + 1) &gt;&#x3D; MAX_POOL) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    lock.lock();</span><br><span class="line">                    if((currValue + 1) &gt;&#x3D; MAX_POOL) &#123;</span><br><span class="line">                        counter.set(0);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    lock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            index &#x3D; (int) (currValue % readDataSourceSize);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F;随机方式</span><br><span class="line">            index &#x3D; ThreadLocalRandom.current().nextInt(0, readDataSourceSize);</span><br><span class="line">        &#125;</span><br><span class="line">        return dynamicDataSourceGlobal.name() + index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setWriteDataSource(Object writeDataSource) &#123;</span><br><span class="line">        this.writeDataSource &#x3D; writeDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setReadDataSources(List&lt;Object&gt; readDataSources) &#123;</span><br><span class="line">        this.readDataSources &#x3D; readDataSources;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setReadDataSourcePollPattern(int readDataSourcePollPattern) &#123;</span><br><span class="line">        this.readDataSourcePollPattern &#x3D; readDataSourcePollPattern;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.log4j.Logger;</span><br><span class="line">import org.aspectj.lang.JoinPoint;</span><br><span class="line">import org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Created by IDEA</span><br><span class="line"> * User: mashaohua</span><br><span class="line"> * Date: 2016-07-07 13:39</span><br><span class="line"> * Desc: 定义选择数据源切面</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class DynamicDataSourceAspect &#123;</span><br><span class="line"></span><br><span class="line">    private static final Logger logger &#x3D; Logger.getLogger(DynamicDataSourceAspect.class);</span><br><span class="line"></span><br><span class="line">    public void pointCut()&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    public void before(JoinPoint point)</span><br><span class="line">    &#123;</span><br><span class="line">        Object target &#x3D; point.getTarget();</span><br><span class="line">        String methodName &#x3D; point.getSignature().getName();</span><br><span class="line">        Class&lt;?&gt;[] clazz &#x3D; target.getClass().getInterfaces();</span><br><span class="line">        Class&lt;?&gt;[] parameterTypes &#x3D; ((MethodSignature) point.getSignature()).getMethod().getParameterTypes();</span><br><span class="line">        try &#123;</span><br><span class="line">            Method method &#x3D; clazz[0].getMethod(methodName, parameterTypes);</span><br><span class="line">            if (method !&#x3D; null &amp;&amp; method.isAnnotationPresent(DataSource.class)) &#123;</span><br><span class="line">                DataSource data &#x3D; method.getAnnotation(DataSource.class);</span><br><span class="line">                DynamicDataSourceHolder.putDataSource(data.value());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            logger.error(String.format(&quot;Choose DataSource error, method:%s, msg:%s&quot;, methodName, e.getMessage()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void after(JoinPoint point) &#123;</span><br><span class="line">        DynamicDataSourceHolder.clearDataSource();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&quot;</span><br><span class="line">       xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">       xmlns:tx&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;tx&quot;</span><br><span class="line">       xmlns:aop&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;aop&quot;</span><br><span class="line">       xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans</span><br><span class="line">       http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&#x2F;spring-beans-4.1.xsd</span><br><span class="line">       http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;tx</span><br><span class="line">       http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;tx&#x2F;spring-tx-4.1.xsd</span><br><span class="line">       http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;aop</span><br><span class="line">       http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;aop&#x2F;spring-aop-4.1.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;abstractDataSource&quot; abstract&#x3D;&quot;true&quot; class&#x3D;&quot;com.alibaba.druid.pool.DruidDataSource&quot; init-method&#x3D;&quot;init&quot; destroy-method&#x3D;&quot;close&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;driverClassName&quot; value&#x3D;&quot;com.microsoft.sqlserver.jdbc.SQLServerDriver&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置获取连接等待超时的时间 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;maxWait&quot; value&#x3D;&quot;60000&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;timeBetweenEvictionRunsMillis&quot; value&#x3D;&quot;60000&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置一个连接在池中最小生存的时间，单位是毫秒 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;minEvictableIdleTimeMillis&quot; value&#x3D;&quot;300000&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;validationQuery&quot; value&#x3D;&quot;SELECT &#39;x&#39;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;testWhileIdle&quot; value&#x3D;&quot;true&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;testOnBorrow&quot; value&#x3D;&quot;false&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;testOnReturn&quot; value&#x3D;&quot;false&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 打开PSCache，并且指定每个连接上PSCache的大小 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;poolPreparedStatements&quot; value&#x3D;&quot;true&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;maxPoolPreparedStatementPerConnectionSize&quot; value&#x3D;&quot;20&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;filters&quot; value&#x3D;&quot;config&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;connectionProperties&quot; value&#x3D;&quot;config.decrypt&#x3D;true&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;dataSourceRead1&quot; parent&#x3D;&quot;abstractDataSource&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;driverClassName&quot; value&#x3D;&quot;com.microsoft.sqlserver.jdbc.SQLServerDriver&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 基本属性 url、user、password --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;read1.jdbc.url&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;$&#123;read1.jdbc.user&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;read1.jdbc.password&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置初始化大小、最小、最大 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;initialSize&quot; value&#x3D;&quot;$&#123;read1.jdbc.initPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;minIdle&quot; value&#x3D;&quot;$&#123;read1.jdbc.minPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;maxActive&quot; value&#x3D;&quot;$&#123;read1.jdbc.maxPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;dataSourceRead2&quot; parent&#x3D;&quot;abstractDataSource&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;driverClassName&quot; value&#x3D;&quot;com.microsoft.sqlserver.jdbc.SQLServerDriver&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 基本属性 url、user、password --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;read2.jdbc.url&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;$&#123;read2.jdbc.user&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;read2.jdbc.password&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置初始化大小、最小、最大 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;initialSize&quot; value&#x3D;&quot;$&#123;read2.jdbc.initPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;minIdle&quot; value&#x3D;&quot;$&#123;read2.jdbc.minPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;maxActive&quot; value&#x3D;&quot;$&#123;read2.jdbc.maxPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;dataSourceWrite&quot; parent&#x3D;&quot;abstractDataSource&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;driverClassName&quot; value&#x3D;&quot;com.microsoft.sqlserver.jdbc.SQLServerDriver&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 基本属性 url、user、password --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;write.jdbc.url&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;$&#123;write.jdbc.user&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;write.jdbc.password&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置初始化大小、最小、最大 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;initialSize&quot; value&#x3D;&quot;$&#123;write.jdbc.initPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;minIdle&quot; value&#x3D;&quot;$&#123;write.jdbc.minPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;maxActive&quot; value&#x3D;&quot;$&#123;write.jdbc.maxPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;dataSource&quot; class&#x3D;&quot;com.test.api.dao.datasource.DynamicDataSource&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;writeDataSource&quot; ref&#x3D;&quot;dataSourceWrite&quot; &#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;readDataSources&quot;&gt;</span><br><span class="line">            &lt;list&gt;</span><br><span class="line">                &lt;ref bean&#x3D;&quot;dataSourceRead1&quot; &#x2F;&gt;</span><br><span class="line">                &lt;ref bean&#x3D;&quot;dataSourceRead2&quot; &#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;list&gt;</span><br><span class="line">        &lt;&#x2F;property&gt;</span><br><span class="line">        &lt;!--轮询方式--&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;readDataSourcePollPattern&quot; value&#x3D;&quot;1&quot; &#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;defaultTargetDataSource&quot; ref&#x3D;&quot;dataSourceWrite&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;tx:annotation-driven transaction-manager&#x3D;&quot;transactionManager&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;transactionManager&quot; class&#x3D;&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;dataSource&quot; ref&#x3D;&quot;dataSource&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 针对myBatis的配置项 --&gt;</span><br><span class="line">    &lt;!-- 配置sqlSessionFactory --&gt;</span><br><span class="line">    &lt;bean id&#x3D;&quot;sqlSessionFactory&quot; class&#x3D;&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">        &lt;!-- 实例化sqlSessionFactory时需要使用上述配置好的数据源以及SQL映射文件 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;dataSource&quot; ref&#x3D;&quot;dataSource&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;mapperLocations&quot; value&#x3D;&quot;classpath:mapper&#x2F;*.xml&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 配置扫描器 --&gt;</span><br><span class="line">    &lt;bean class&#x3D;&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">        &lt;!-- 扫描包以及它的子包下的所有映射接口类 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;basePackage&quot; value&#x3D;&quot;com.test.api.dao.inte&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;sqlSessionFactoryBeanName&quot; value&#x3D;&quot;sqlSessionFactory&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 配置数据库注解aop --&gt;</span><br><span class="line">    &lt;bean id&#x3D;&quot;dynamicDataSourceAspect&quot; class&#x3D;&quot;com.test.api.dao.datasource.DynamicDataSourceAspect&quot; &#x2F;&gt;</span><br><span class="line">    &lt;aop:config&gt;</span><br><span class="line">        &lt;aop:aspect id&#x3D;&quot;c&quot; ref&#x3D;&quot;dynamicDataSourceAspect&quot;&gt;</span><br><span class="line">            &lt;aop:pointcut id&#x3D;&quot;tx&quot; expression&#x3D;&quot;execution(* com.test.api.dao.inte..*.*(..))&quot;&#x2F;&gt;</span><br><span class="line">            &lt;aop:before pointcut-ref&#x3D;&quot;tx&quot; method&#x3D;&quot;before&quot;&#x2F;&gt;</span><br><span class="line">            &lt;aop:after pointcut-ref&#x3D;&quot;tx&quot; method&#x3D;&quot;after&quot;&#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;aop:aspect&gt;</span><br><span class="line">    &lt;&#x2F;aop:config&gt;</span><br><span class="line">    &lt;!-- 配置数据库注解aop --&gt;</span><br><span class="line">&lt;&#x2F;beans&gt;</span><br></pre></td></tr></table></figure>

<h5 id="方案3"><a href="#方案3" class="headerlink" title="方案3"></a>方案3</h5><blockquote>
<p>通过Mybatis的Plugin在业务层实现数据库读写分离，在MyBatis创建Statement对象前通过拦截器选择真正的数据源，在拦截器中根据方法名称不同（select、update、insert、delete）选择数据源。</p>
</blockquote>
<ul>
<li>优点：原有代码不变，支持多读，易扩展</li>
<li>缺点：</li>
<li>实现方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Created by IDEA</span><br><span class="line"> * User: mashaohua</span><br><span class="line"> * Date: 2016-07-19 15:40</span><br><span class="line"> * Desc: 创建Connection代理接口</span><br><span class="line"> *&#x2F;</span><br><span class="line">public interface ConnectionProxy extends Connection &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 根据传入的读写分离需要的key路由到正确的connection</span><br><span class="line">     * @param key 数据源标识</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    Connection  getTargetConnection(String key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br></pre></td><td class="code"><pre><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.InvocationTargetException;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.sql.Connection;</span><br><span class="line">import java.sql.SQLException;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line">import javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.InitializingBean;</span><br><span class="line">import org.springframework.jdbc.datasource.AbstractDataSource;</span><br><span class="line">import org.springframework.jdbc.datasource.lookup.DataSourceLookup;</span><br><span class="line">import org.springframework.jdbc.datasource.lookup.JndiDataSourceLookup;</span><br><span class="line">import org.springframework.util.Assert;</span><br><span class="line"></span><br><span class="line">public abstract class AbstractDynamicDataSourceProxy extends AbstractDataSource implements InitializingBean &#123;</span><br><span class="line"></span><br><span class="line">    private List&lt;Object&gt; readDataSources;</span><br><span class="line">    private List&lt;DataSource&gt; resolvedReadDataSources;</span><br><span class="line"></span><br><span class="line">    private Object writeDataSource;</span><br><span class="line">    private DataSource resolvedWriteDataSource;</span><br><span class="line"></span><br><span class="line">    private int readDataSourcePollPattern &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    private int readDsSize;</span><br><span class="line"></span><br><span class="line">    private boolean defaultAutoCommit &#x3D; true;</span><br><span class="line">    private int defaultTransactionIsolation &#x3D; Connection.TRANSACTION_READ_COMMITTED;</span><br><span class="line"></span><br><span class="line">    public static final String READ &#x3D; &quot;read&quot;;</span><br><span class="line"></span><br><span class="line">    public static final String WRITE &#x3D; &quot;write&quot;;</span><br><span class="line"></span><br><span class="line">    private DataSourceLookup dataSourceLookup &#x3D; new JndiDataSourceLookup();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Connection getConnection() throws SQLException &#123;</span><br><span class="line">        return (Connection) Proxy.newProxyInstance(</span><br><span class="line">                com.autohome.api.dealer.tuan.dao.rwmybatis.ConnectionProxy.class.getClassLoader(),</span><br><span class="line">                new Class[] &#123;com.autohome.api.dealer.tuan.dao.rwmybatis.ConnectionProxy.class&#125;,</span><br><span class="line">                new RWConnectionInvocationHandler());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Connection getConnection(String username, String password)</span><br><span class="line">            throws SQLException &#123;</span><br><span class="line">        return (Connection) Proxy.newProxyInstance(</span><br><span class="line">                com.autohome.api.dealer.tuan.dao.rwmybatis.ConnectionProxy.class.getClassLoader(),</span><br><span class="line">                new Class[] &#123;com.autohome.api.dealer.tuan.dao.rwmybatis.ConnectionProxy.class&#125;,</span><br><span class="line">                new RWConnectionInvocationHandler(username,password));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getReadDsSize()&#123;</span><br><span class="line">        return readDsSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;DataSource&gt; getResolvedReadDataSources() &#123;</span><br><span class="line">        return resolvedReadDataSources;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        if(writeDataSource &#x3D;&#x3D; null)&#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;Property &#39;writeDataSource&#39; is required&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        this.resolvedWriteDataSource &#x3D; resolveSpecifiedDataSource(writeDataSource);</span><br><span class="line"></span><br><span class="line">        resolvedReadDataSources &#x3D; new ArrayList&lt;DataSource&gt;(readDataSources.size());</span><br><span class="line">        for(Object item : readDataSources)&#123;</span><br><span class="line">            resolvedReadDataSources.add(resolveSpecifiedDataSource(item));</span><br><span class="line">        &#125;</span><br><span class="line">        readDsSize &#x3D; readDataSources.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected DataSource determineTargetDataSource(String key) &#123;</span><br><span class="line">        Assert.notNull(this.resolvedReadDataSources, &quot;DataSource router not initialized&quot;);</span><br><span class="line">        if(WRITE.equals(key))&#123;</span><br><span class="line">            return resolvedWriteDataSource;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            return loadReadDataSource();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Logger getParentLogger() &#123;</span><br><span class="line">        &#x2F;&#x2F; NOOP Just ignore</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 获取真实的data source</span><br><span class="line">     * @param dataSource (jndi | real data source)</span><br><span class="line">     * @return</span><br><span class="line">     * @throws IllegalArgumentException</span><br><span class="line">     *&#x2F;</span><br><span class="line">    protected DataSource resolveSpecifiedDataSource(Object dataSource) throws IllegalArgumentException &#123;</span><br><span class="line">        if (dataSource instanceof DataSource) &#123;</span><br><span class="line">            return (DataSource) dataSource;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (dataSource instanceof String) &#123;</span><br><span class="line">            return this.dataSourceLookup.getDataSource((String) dataSource);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            throw new IllegalArgumentException(</span><br><span class="line">                    &quot;Illegal data source value - only [javax.sql.DataSource] and String supported: &quot; + dataSource);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected abstract DataSource loadReadDataSource();</span><br><span class="line"></span><br><span class="line">    public void setReadDsSize(int readDsSize) &#123;</span><br><span class="line">        this.readDsSize &#x3D; readDsSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;Object&gt; getReadDataSources() &#123;</span><br><span class="line">        return readDataSources;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setReadDataSources(List&lt;Object&gt; readDataSources) &#123;</span><br><span class="line">        this.readDataSources &#x3D; readDataSources;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object getWriteDataSource() &#123;</span><br><span class="line">        return writeDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setWriteDataSource(Object writeDataSource) &#123;</span><br><span class="line">        this.writeDataSource &#x3D; writeDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setResolvedReadDataSources(List&lt;DataSource&gt; resolvedReadDataSources) &#123;</span><br><span class="line">        this.resolvedReadDataSources &#x3D; resolvedReadDataSources;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public DataSource getResolvedWriteDataSource() &#123;</span><br><span class="line">        return resolvedWriteDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setResolvedWriteDataSource(DataSource resolvedWriteDataSource) &#123;</span><br><span class="line">        this.resolvedWriteDataSource &#x3D; resolvedWriteDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getReadDataSourcePollPattern() &#123;</span><br><span class="line">        return readDataSourcePollPattern;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setReadDataSourcePollPattern(int readDataSourcePollPattern) &#123;</span><br><span class="line">        this.readDataSourcePollPattern &#x3D; readDataSourcePollPattern;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Invocation handler that defers fetching an actual JDBC Connection</span><br><span class="line">     * until first creation of a Statement.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private class RWConnectionInvocationHandler implements InvocationHandler &#123;</span><br><span class="line"></span><br><span class="line">        private String username;</span><br><span class="line"></span><br><span class="line">        private String password;</span><br><span class="line"></span><br><span class="line">        private Boolean readOnly &#x3D; Boolean.FALSE;</span><br><span class="line"></span><br><span class="line">        private Integer transactionIsolation;</span><br><span class="line"></span><br><span class="line">        private Boolean autoCommit;</span><br><span class="line"></span><br><span class="line">        private boolean closed &#x3D; false;</span><br><span class="line"></span><br><span class="line">        private Connection target;</span><br><span class="line"></span><br><span class="line">        public RWConnectionInvocationHandler() &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public RWConnectionInvocationHandler(String username, String password) &#123;</span><br><span class="line">            this();</span><br><span class="line">            this.username &#x3D; username;</span><br><span class="line">            this.password &#x3D; password;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">            &#x2F;&#x2F; Invocation on ConnectionProxy interface coming in...</span><br><span class="line"></span><br><span class="line">            if (method.getName().equals(&quot;equals&quot;)) &#123;</span><br><span class="line">                &#x2F;&#x2F; We must avoid fetching a target Connection for &quot;equals&quot;.</span><br><span class="line">                &#x2F;&#x2F; Only consider equal when proxies are identical.</span><br><span class="line">                return (proxy &#x3D;&#x3D; args[0] ? Boolean.TRUE : Boolean.FALSE);</span><br><span class="line">            &#125;</span><br><span class="line">            else if (method.getName().equals(&quot;hashCode&quot;)) &#123;</span><br><span class="line">                &#x2F;&#x2F; We must avoid fetching a target Connection for &quot;hashCode&quot;,</span><br><span class="line">                &#x2F;&#x2F; and we must return the same hash code even when the target</span><br><span class="line">                &#x2F;&#x2F; Connection has been fetched: use hashCode of Connection proxy.</span><br><span class="line">                return new Integer(System.identityHashCode(proxy));</span><br><span class="line">            &#125;</span><br><span class="line">            else if (method.getName().equals(&quot;getTargetConnection&quot;)) &#123;</span><br><span class="line">                &#x2F;&#x2F; Handle getTargetConnection method: return underlying connection.</span><br><span class="line">                return getTargetConnection(method,args);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!hasTargetConnection()) &#123;</span><br><span class="line">                &#x2F;&#x2F; No physical target Connection kept yet -&gt;</span><br><span class="line">                &#x2F;&#x2F; resolve transaction demarcation methods without fetching</span><br><span class="line">                &#x2F;&#x2F; a physical JDBC Connection until absolutely necessary.</span><br><span class="line"></span><br><span class="line">                if (method.getName().equals(&quot;toString&quot;)) &#123;</span><br><span class="line">                    return &quot;RW Routing DataSource Proxy&quot;;</span><br><span class="line">                &#125;</span><br><span class="line">                else if (method.getName().equals(&quot;isReadOnly&quot;)) &#123;</span><br><span class="line">                    return this.readOnly;</span><br><span class="line">                &#125;</span><br><span class="line">                else if (method.getName().equals(&quot;setReadOnly&quot;)) &#123;</span><br><span class="line">                    this.readOnly &#x3D; (Boolean) args[0];</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">                else if (method.getName().equals(&quot;getTransactionIsolation&quot;)) &#123;</span><br><span class="line">                    if (this.transactionIsolation !&#x3D; null) &#123;</span><br><span class="line">                        return this.transactionIsolation;</span><br><span class="line">                    &#125;</span><br><span class="line">                    return defaultTransactionIsolation;</span><br><span class="line">                    &#x2F;&#x2F; Else fetch actual Connection and check there,</span><br><span class="line">                    &#x2F;&#x2F; because we didn&#39;t have a default specified.</span><br><span class="line">                &#125;</span><br><span class="line">                else if (method.getName().equals(&quot;setTransactionIsolation&quot;)) &#123;</span><br><span class="line">                    this.transactionIsolation &#x3D; (Integer) args[0];</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">                else if (method.getName().equals(&quot;getAutoCommit&quot;)) &#123;</span><br><span class="line">                    if (this.autoCommit !&#x3D; null)</span><br><span class="line">                        return this.autoCommit;</span><br><span class="line">                    return defaultAutoCommit;</span><br><span class="line">                    &#x2F;&#x2F; Else fetch actual Connection and check there,</span><br><span class="line">                    &#x2F;&#x2F; because we didn&#39;t have a default specified.</span><br><span class="line">                &#125;</span><br><span class="line">                else if (method.getName().equals(&quot;setAutoCommit&quot;)) &#123;</span><br><span class="line">                    this.autoCommit &#x3D; (Boolean) args[0];</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">                else if (method.getName().equals(&quot;commit&quot;)) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Ignore: no statements created yet.</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">                else if (method.getName().equals(&quot;rollback&quot;)) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Ignore: no statements created yet.</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">                else if (method.getName().equals(&quot;getWarnings&quot;)) &#123;</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">                else if (method.getName().equals(&quot;clearWarnings&quot;)) &#123;</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">                else if (method.getName().equals(&quot;isClosed&quot;)) &#123;</span><br><span class="line">                    return (this.closed ? Boolean.TRUE : Boolean.FALSE);</span><br><span class="line">                &#125;</span><br><span class="line">                else if (method.getName().equals(&quot;close&quot;)) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Ignore: no target connection yet.</span><br><span class="line">                    this.closed &#x3D; true;</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">                else if (this.closed) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Connection proxy closed, without ever having fetched a</span><br><span class="line">                    &#x2F;&#x2F; physical JDBC Connection: throw corresponding SQLException.</span><br><span class="line">                    throw new SQLException(&quot;Illegal operation: connection is closed&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Target Connection already fetched,</span><br><span class="line">            &#x2F;&#x2F; or target Connection necessary for current operation -&gt;</span><br><span class="line">            &#x2F;&#x2F; invoke method on target connection.</span><br><span class="line">            try &#123;</span><br><span class="line">                return method.invoke(target, args);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (InvocationTargetException ex) &#123;</span><br><span class="line">                throw ex.getTargetException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * Return whether the proxy currently holds a target Connection.</span><br><span class="line">         *&#x2F;</span><br><span class="line">        private boolean hasTargetConnection() &#123;</span><br><span class="line">            return (this.target !&#x3D; null);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * Return the target Connection, fetching it and initializing it if necessary.</span><br><span class="line">         *&#x2F;</span><br><span class="line">        private Connection getTargetConnection(Method operation,Object[] args) throws SQLException &#123;</span><br><span class="line"></span><br><span class="line">            if (this.target &#x3D;&#x3D; null) &#123;</span><br><span class="line">                String key &#x3D; (String) args[0];</span><br><span class="line">                &#x2F;&#x2F; No target Connection held -&gt; fetch one.</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Connecting to database for operation &#39;&quot; + operation.getName() + &quot;&#39;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; Fetch physical Connection from DataSource.</span><br><span class="line">                this.target &#x3D; (this.username !&#x3D; null) ?</span><br><span class="line">                        determineTargetDataSource(key).getConnection(this.username, this.password) :</span><br><span class="line">                        determineTargetDataSource(key).getConnection();</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; If we still lack default connection properties, check them now.</span><br><span class="line">                &#x2F;&#x2F;checkDefaultConnectionProperties(this.target);</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; Apply kept transaction settings, if any.</span><br><span class="line">                if (this.readOnly.booleanValue()) &#123;</span><br><span class="line">                    this.target.setReadOnly(this.readOnly.booleanValue());</span><br><span class="line">                &#125;</span><br><span class="line">                if (this.transactionIsolation !&#x3D; null) &#123;</span><br><span class="line">                    this.target.setTransactionIsolation(this.transactionIsolation.intValue());</span><br><span class="line">                &#125;</span><br><span class="line">                if (this.autoCommit !&#x3D; null &amp;&amp; this.autoCommit.booleanValue() !&#x3D; this.target.getAutoCommit()) &#123;</span><br><span class="line">                    this.target.setAutoCommit(this.autoCommit.booleanValue());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            else &#123;</span><br><span class="line">                &#x2F;&#x2F; Target Connection already held -&gt; return it.</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Using existing database connection for operation &#39;&quot; + operation.getName() + &quot;&#39;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return this.target;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">import javax.sql.DataSource;</span><br><span class="line">import java.util.concurrent.ThreadLocalRandom;</span><br><span class="line">import java.util.concurrent.atomic.AtomicLong;</span><br><span class="line">import java.util.concurrent.locks.Lock;</span><br><span class="line">import java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Created by IDEA</span><br><span class="line"> * User: mashaohua</span><br><span class="line"> * Date: 2016-07-19 16:04</span><br><span class="line"> * Desc:</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class DynamicRoutingDataSourceProxy extends AbstractDynamicDataSourceProxy &#123;</span><br><span class="line"></span><br><span class="line">    private AtomicLong counter &#x3D; new AtomicLong(0);</span><br><span class="line"></span><br><span class="line">    private static final Long MAX_POOL &#x3D; Long.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">    private final Lock lock &#x3D; new ReentrantLock();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected DataSource loadReadDataSource() &#123;</span><br><span class="line">        int index &#x3D; 1;</span><br><span class="line"></span><br><span class="line">        if(getReadDataSourcePollPattern() &#x3D;&#x3D; 1) &#123;</span><br><span class="line">            &#x2F;&#x2F;轮询方式</span><br><span class="line">            long currValue &#x3D; counter.incrementAndGet();</span><br><span class="line">            if((currValue + 1) &gt;&#x3D; MAX_POOL) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    lock.lock();</span><br><span class="line">                    if((currValue + 1) &gt;&#x3D; MAX_POOL) &#123;</span><br><span class="line">                        counter.set(0);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    lock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            index &#x3D; (int) (currValue % getReadDsSize());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F;随机方式</span><br><span class="line">            index &#x3D; ThreadLocalRandom.current().nextInt(0, getReadDsSize());</span><br><span class="line">        &#125;</span><br><span class="line">        return getResolvedReadDataSources().get(index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.ibatis.executor.statement.RoutingStatementHandler;</span><br><span class="line">import org.apache.ibatis.executor.statement.StatementHandler;</span><br><span class="line">import org.apache.ibatis.mapping.MappedStatement;</span><br><span class="line">import org.apache.ibatis.mapping.SqlCommandType;</span><br><span class="line">import org.apache.ibatis.plugin.*;</span><br><span class="line"></span><br><span class="line">import java.sql.Connection;</span><br><span class="line">import java.util.Properties;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 拦截器</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Intercepts(&#123; @Signature(type &#x3D; StatementHandler.class, method &#x3D; &quot;prepare&quot;, args &#x3D; &#123; Connection.class &#125;) &#125;)</span><br><span class="line">public class DynamicPlugin implements Interceptor &#123;</span><br><span class="line"></span><br><span class="line">    public Object intercept(Invocation invocation) throws Throwable &#123;</span><br><span class="line"></span><br><span class="line">        Connection conn &#x3D; (Connection)invocation.getArgs()[0];</span><br><span class="line">        &#x2F;&#x2F;如果是采用了我们代理,则路由数据源</span><br><span class="line">        if(conn instanceof com.autohome.api.dealer.tuan.dao.rwmybatis.ConnectionProxy)&#123;</span><br><span class="line">            StatementHandler statementHandler &#x3D; (StatementHandler) invocation</span><br><span class="line">                    .getTarget();</span><br><span class="line"></span><br><span class="line">            MappedStatement mappedStatement &#x3D; null;</span><br><span class="line">            if (statementHandler instanceof RoutingStatementHandler) &#123;</span><br><span class="line">                StatementHandler delegate &#x3D; (StatementHandler) ReflectionUtils</span><br><span class="line">                        .getFieldValue(statementHandler, &quot;delegate&quot;);</span><br><span class="line">                mappedStatement &#x3D; (MappedStatement) ReflectionUtils.getFieldValue(</span><br><span class="line">                        delegate, &quot;mappedStatement&quot;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                mappedStatement &#x3D; (MappedStatement) ReflectionUtils.getFieldValue(</span><br><span class="line">                        statementHandler, &quot;mappedStatement&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            String key &#x3D; AbstractDynamicDataSourceProxy.WRITE;</span><br><span class="line"></span><br><span class="line">            if(mappedStatement.getSqlCommandType() &#x3D;&#x3D; SqlCommandType.SELECT)&#123;</span><br><span class="line">                key &#x3D; AbstractDynamicDataSourceProxy.READ;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                key &#x3D; AbstractDynamicDataSourceProxy.WRITE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ConnectionProxy connectionProxy &#x3D; (ConnectionProxy)conn;</span><br><span class="line">            connectionProxy.getTargetConnection(key);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return invocation.proceed();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object plugin(Object target) &#123;</span><br><span class="line"></span><br><span class="line">        return Plugin.wrap(target, this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setProperties(Properties properties) &#123;</span><br><span class="line">        &#x2F;&#x2F;NOOP</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.ibatis.logging.Log;</span><br><span class="line">import org.apache.ibatis.logging.LogFactory;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line">public class ReflectionUtils &#123;</span><br><span class="line"></span><br><span class="line">    private static final Log logger &#x3D; LogFactory.getLog(ReflectionUtils.class);</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 直接设置对象属性值,无视private&#x2F;protected修饰符,不经过setter函数.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void setFieldValue(final Object object, final String fieldName, final Object value) &#123;</span><br><span class="line">        Field field &#x3D; getDeclaredField(object, fieldName);</span><br><span class="line"></span><br><span class="line">        if (field &#x3D;&#x3D; null)</span><br><span class="line">            throw new IllegalArgumentException(&quot;Could not find field [&quot; + fieldName + &quot;] on target [&quot; + object + &quot;]&quot;);</span><br><span class="line"></span><br><span class="line">        makeAccessible(field);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            field.set(object, value);</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 直接读取对象属性值,无视private&#x2F;protected修饰符,不经过getter函数.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static Object getFieldValue(final Object object, final String fieldName) &#123;</span><br><span class="line">        Field field &#x3D; getDeclaredField(object, fieldName);</span><br><span class="line"></span><br><span class="line">        if (field &#x3D;&#x3D; null)</span><br><span class="line">            throw new IllegalArgumentException(&quot;Could not find field [&quot; + fieldName + &quot;] on target [&quot; + object + &quot;]&quot;);</span><br><span class="line"></span><br><span class="line">        makeAccessible(field);</span><br><span class="line"></span><br><span class="line">        Object result &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            result &#x3D; field.get(object);</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 直接调用对象方法,无视private&#x2F;protected修饰符.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static Object invokeMethod(final Object object, final String methodName, final Class&lt;?&gt;[] parameterTypes,</span><br><span class="line">            final Object[] parameters) throws InvocationTargetException &#123;</span><br><span class="line">        Method method &#x3D; getDeclaredMethod(object, methodName, parameterTypes);</span><br><span class="line">        if (method &#x3D;&#x3D; null)</span><br><span class="line">            throw new IllegalArgumentException(&quot;Could not find method [&quot; + methodName + &quot;] on target [&quot; + object + &quot;]&quot;);</span><br><span class="line"></span><br><span class="line">        method.setAccessible(true);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            return method.invoke(object, parameters);</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 循环向上转型,获取对象的DeclaredField.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    protected static Field getDeclaredField(final Object object, final String fieldName) &#123;</span><br><span class="line">        for (Class&lt;?&gt; superClass &#x3D; object.getClass(); superClass !&#x3D; Object.class; superClass &#x3D; superClass</span><br><span class="line">                .getSuperclass()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                return superClass.getDeclaredField(fieldName);</span><br><span class="line">            &#125; catch (NoSuchFieldException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 循环向上转型,获取对象的DeclaredField.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    protected static void makeAccessible(final Field field) &#123;</span><br><span class="line">        if (!Modifier.isPublic(field.getModifiers()) || !Modifier.isPublic(field.getDeclaringClass().getModifiers())) &#123;</span><br><span class="line">            field.setAccessible(true);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 循环向上转型,获取对象的DeclaredMethod.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    protected static Method getDeclaredMethod(Object object, String methodName, Class&lt;?&gt;[] parameterTypes) &#123;</span><br><span class="line">        for (Class&lt;?&gt; superClass &#x3D; object.getClass(); superClass !&#x3D; Object.class; superClass &#x3D; superClass</span><br><span class="line">                .getSuperclass()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                return superClass.getDeclaredMethod(methodName, parameterTypes);</span><br><span class="line">            &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 通过反射,获得Class定义中声明的父类的泛型参数的类型.</span><br><span class="line">     * eg.</span><br><span class="line">     * public UserDao extends HibernateDao&lt;User&gt;</span><br><span class="line">     *</span><br><span class="line">     * @param clazz The class to introspect</span><br><span class="line">     * @return the first generic declaration, or Object.class if cannot be determined</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public static &lt;T&gt; Class&lt;T&gt; getSuperClassGenricType(final Class clazz) &#123;</span><br><span class="line">        return getSuperClassGenricType(clazz, 0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 通过反射,获得Class定义中声明的父类的泛型参数的类型.</span><br><span class="line">     * eg.</span><br><span class="line">     * public UserDao extends HibernateDao&lt;User&gt;</span><br><span class="line">     *</span><br><span class="line">     * @param clazz The class to introspect</span><br><span class="line">     * @return the first generic declaration, or Object.class if cannot be determined</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public static Class getSuperClassGenricType(final Class clazz, final int index) &#123;</span><br><span class="line"></span><br><span class="line">        Type genType &#x3D; clazz.getGenericSuperclass();</span><br><span class="line"></span><br><span class="line">        if (!(genType instanceof ParameterizedType)) &#123;</span><br><span class="line">            logger.warn(clazz.getSimpleName() + &quot;&#39;s superclass not ParameterizedType&quot;);</span><br><span class="line">            return Object.class;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Type[] params &#x3D; ((ParameterizedType) genType).getActualTypeArguments();</span><br><span class="line"></span><br><span class="line">        if (index &gt;&#x3D; params.length || index &lt; 0) &#123;</span><br><span class="line">            logger.warn(&quot;Index: &quot; + index + &quot;, Size of &quot; + clazz.getSimpleName() + &quot;&#39;s Parameterized Type: &quot;</span><br><span class="line">                    + params.length);</span><br><span class="line">            return Object.class;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!(params[index] instanceof Class)) &#123;</span><br><span class="line">            logger.warn(clazz.getSimpleName() + &quot; not set the actual class on superclass generic parameter&quot;);</span><br><span class="line">            return Object.class;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return (Class) params[index];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 将反射时的checked exception转换为unchecked exception.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static IllegalArgumentException convertToUncheckedException(Exception e) &#123;</span><br><span class="line">        if (e instanceof IllegalAccessException || e instanceof IllegalArgumentException</span><br><span class="line">                || e instanceof NoSuchMethodException)</span><br><span class="line">            return new IllegalArgumentException(&quot;Refelction Exception.&quot;, e);</span><br><span class="line">        else</span><br><span class="line">            return new IllegalArgumentException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration PUBLIC &quot;-&#x2F;&#x2F;mybatis.org&#x2F;&#x2F;DTD SQL Map Config 3.0&#x2F;&#x2F;EN&quot;  </span><br><span class="line">    &quot;http:&#x2F;&#x2F;mybatis.org&#x2F;dtd&#x2F;mybatis-3-config.dtd&quot;&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin interceptor&#x3D;&quot;com.test.api.dao.mybatis.DynamicPlugin&quot;&gt;</span><br><span class="line">        &lt;&#x2F;plugin&gt;</span><br><span class="line">    &lt;&#x2F;plugins&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;configuration&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&quot;</span><br><span class="line">       xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">       xmlns:tx&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;tx&quot;</span><br><span class="line">       xmlns:aop&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;aop&quot;</span><br><span class="line">       xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans</span><br><span class="line">       http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&#x2F;spring-beans-4.1.xsd</span><br><span class="line">       http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;tx</span><br><span class="line">       http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;tx&#x2F;spring-tx-4.1.xsd</span><br><span class="line">       http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;aop</span><br><span class="line">       http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;aop&#x2F;spring-aop-4.1.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;abstractDataSource&quot; abstract&#x3D;&quot;true&quot; class&#x3D;&quot;com.alibaba.druid.pool.DruidDataSource&quot; init-method&#x3D;&quot;init&quot; destroy-method&#x3D;&quot;close&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;driverClassName&quot; value&#x3D;&quot;com.microsoft.sqlserver.jdbc.SQLServerDriver&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置获取连接等待超时的时间 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;maxWait&quot; value&#x3D;&quot;60000&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;timeBetweenEvictionRunsMillis&quot; value&#x3D;&quot;60000&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置一个连接在池中最小生存的时间，单位是毫秒 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;minEvictableIdleTimeMillis&quot; value&#x3D;&quot;300000&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;validationQuery&quot; value&#x3D;&quot;SELECT &#39;x&#39;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;testWhileIdle&quot; value&#x3D;&quot;true&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;testOnBorrow&quot; value&#x3D;&quot;false&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;testOnReturn&quot; value&#x3D;&quot;false&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 打开PSCache，并且指定每个连接上PSCache的大小 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;poolPreparedStatements&quot; value&#x3D;&quot;true&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;maxPoolPreparedStatementPerConnectionSize&quot; value&#x3D;&quot;20&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;filters&quot; value&#x3D;&quot;config&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;connectionProperties&quot; value&#x3D;&quot;config.decrypt&#x3D;true&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;dataSourceRead1&quot; parent&#x3D;&quot;abstractDataSource&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;driverClassName&quot; value&#x3D;&quot;com.microsoft.sqlserver.jdbc.SQLServerDriver&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 基本属性 url、user、password --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;read1.jdbc.url&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;$&#123;read1.jdbc.user&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;read1.jdbc.password&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置初始化大小、最小、最大 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;initialSize&quot; value&#x3D;&quot;$&#123;read1.jdbc.initPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;minIdle&quot; value&#x3D;&quot;$&#123;read1.jdbc.minPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;maxActive&quot; value&#x3D;&quot;$&#123;read1.jdbc.maxPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;dataSourceRead2&quot; parent&#x3D;&quot;abstractDataSource&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;driverClassName&quot; value&#x3D;&quot;com.microsoft.sqlserver.jdbc.SQLServerDriver&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 基本属性 url、user、password --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;read2.jdbc.url&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;$&#123;read2.jdbc.user&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;read2.jdbc.password&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置初始化大小、最小、最大 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;initialSize&quot; value&#x3D;&quot;$&#123;read2.jdbc.initPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;minIdle&quot; value&#x3D;&quot;$&#123;read2.jdbc.minPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;maxActive&quot; value&#x3D;&quot;$&#123;read2.jdbc.maxPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;dataSourceWrite&quot; parent&#x3D;&quot;abstractDataSource&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;driverClassName&quot; value&#x3D;&quot;com.microsoft.sqlserver.jdbc.SQLServerDriver&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 基本属性 url、user、password --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;write.jdbc.url&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;$&#123;write.jdbc.user&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;write.jdbc.password&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置初始化大小、最小、最大 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;initialSize&quot; value&#x3D;&quot;$&#123;write.jdbc.initPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;minIdle&quot; value&#x3D;&quot;$&#123;write.jdbc.minPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;maxActive&quot; value&#x3D;&quot;$&#123;write.jdbc.maxPoolSize&#125;&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;dataSource&quot; class&#x3D;&quot;com.test.api.dao.datasource.DynamicRoutingDataSourceProxy&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;writeDataSource&quot; ref&#x3D;&quot;dataSourceWrite&quot; &#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;readDataSources&quot;&gt;</span><br><span class="line">            &lt;list&gt;</span><br><span class="line">                &lt;ref bean&#x3D;&quot;dataSourceRead1&quot; &#x2F;&gt;</span><br><span class="line">                &lt;ref bean&#x3D;&quot;dataSourceRead2&quot; &#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;list&gt;</span><br><span class="line">        &lt;&#x2F;property&gt;</span><br><span class="line">        &lt;!--轮询方式--&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;readDataSourcePollPattern&quot; value&#x3D;&quot;1&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;tx:annotation-driven transaction-manager&#x3D;&quot;transactionManager&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;transactionManager&quot; class&#x3D;&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;dataSource&quot; ref&#x3D;&quot;dataSource&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 针对myBatis的配置项 --&gt;</span><br><span class="line">    &lt;!-- 配置sqlSessionFactory --&gt;</span><br><span class="line">    &lt;bean id&#x3D;&quot;sqlSessionFactory&quot; class&#x3D;&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">        &lt;!-- 实例化sqlSessionFactory时需要使用上述配置好的数据源以及SQL映射文件 --&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;dataSource&quot; ref&#x3D;&quot;dataSource&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;mapperLocations&quot; value&#x3D;&quot;classpath:mapper&#x2F;*.xml&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;configLocation&quot; value&#x3D;&quot;classpath:mybatis-plugin-config.xml&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;sqlSessionTemplate&quot; class&#x3D;&quot;org.mybatis.spring.SqlSessionTemplate&quot;&gt;</span><br><span class="line">        &lt;constructor-arg ref&#x3D;&quot;sqlSessionFactory&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line">    &lt;!-- 通过扫描的模式，扫描目录下所有的mapper， 根据对应的mapper.xml为其生成代理类--&gt;</span><br><span class="line">    &lt;bean id&#x3D;&quot;mapper&quot; class&#x3D;&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;basePackage&quot; value&#x3D;&quot;com.test.api.dao.inte&quot; &#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;sqlSessionTemplate&quot; ref&#x3D;&quot;sqlSessionTemplate&quot;&gt;&lt;&#x2F;property&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;beans&gt;</span><br></pre></td></tr></table></figure>

<h5 id="方案4"><a href="#方案4" class="headerlink" title="方案4"></a>方案4</h5><blockquote>
<p>如果你的后台结构是spring+mybatis，可以通过spring的AbstractRoutingDataSource和mybatis Plugin拦截器实现非常友好的读写分离，原有代码不需要任何改变。推荐第四种方案</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Created by IDEA</span><br><span class="line"> * User: mashaohua</span><br><span class="line"> * Date: 2016-07-14 10:56</span><br><span class="line"> * Desc: 动态数据源实现读写分离</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class DynamicDataSource extends AbstractRoutingDataSource &#123;</span><br><span class="line"></span><br><span class="line">    private Object writeDataSource; &#x2F;&#x2F;写数据源</span><br><span class="line"></span><br><span class="line">    private Object readDataSource; &#x2F;&#x2F;读数据源</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void afterPropertiesSet() &#123;</span><br><span class="line">        if (this.writeDataSource &#x3D;&#x3D; null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;Property &#39;writeDataSource&#39; is required&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        setDefaultTargetDataSource(writeDataSource);</span><br><span class="line">        Map&lt;Object, Object&gt; targetDataSources &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">        targetDataSources.put(DynamicDataSourceGlobal.WRITE.name(), writeDataSource);</span><br><span class="line">        if(readDataSource !&#x3D; null) &#123;</span><br><span class="line">            targetDataSources.put(DynamicDataSourceGlobal.READ.name(), readDataSource);</span><br><span class="line">        &#125;</span><br><span class="line">        setTargetDataSources(targetDataSources);</span><br><span class="line">        super.afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Object determineCurrentLookupKey() &#123;</span><br><span class="line"></span><br><span class="line">        DynamicDataSourceGlobal dynamicDataSourceGlobal &#x3D; DynamicDataSourceHolder.getDataSource();</span><br><span class="line"></span><br><span class="line">        if(dynamicDataSourceGlobal &#x3D;&#x3D; null</span><br><span class="line">                || dynamicDataSourceGlobal &#x3D;&#x3D; DynamicDataSourceGlobal.WRITE) &#123;</span><br><span class="line">            return DynamicDataSourceGlobal.WRITE.name();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return DynamicDataSourceGlobal.READ.name();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setWriteDataSource(Object writeDataSource) &#123;</span><br><span class="line">        this.writeDataSource &#x3D; writeDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object getWriteDataSource() &#123;</span><br><span class="line">        return writeDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object getReadDataSource() &#123;</span><br><span class="line">        return readDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setReadDataSource(Object readDataSource) &#123;</span><br><span class="line">        this.readDataSource &#x3D; readDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Created by IDEA</span><br><span class="line"> * User: mashaohua</span><br><span class="line"> * Date: 2016-07-14 10:58</span><br><span class="line"> * Desc:</span><br><span class="line"> *&#x2F;</span><br><span class="line">public enum DynamicDataSourceGlobal &#123;</span><br><span class="line">    READ, WRITE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public final class DynamicDataSourceHolder &#123;</span><br><span class="line"></span><br><span class="line">    private static final ThreadLocal&lt;DynamicDataSourceGlobal&gt; holder &#x3D; new ThreadLocal&lt;DynamicDataSourceGlobal&gt;();</span><br><span class="line"></span><br><span class="line">    private DynamicDataSourceHolder() &#123;</span><br><span class="line">        &#x2F;&#x2F;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void putDataSource(DynamicDataSourceGlobal dataSource)&#123;</span><br><span class="line">        holder.set(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static DynamicDataSourceGlobal getDataSource()&#123;</span><br><span class="line">        return holder.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void clearDataSource() &#123;</span><br><span class="line">        holder.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class="line">import org.springframework.transaction.TransactionDefinition;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Created by IDEA</span><br><span class="line"> * User: mashaohua</span><br><span class="line"> * Date: 2016-08-10 14:34</span><br><span class="line"> * Desc:</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class DynamicDataSourceTransactionManager extends DataSourceTransactionManager &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 只读事务到读库，读写事务到写库</span><br><span class="line">     * @param transaction</span><br><span class="line">     * @param definition</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    protected void doBegin(Object transaction, TransactionDefinition definition) &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;设置数据源</span><br><span class="line">        boolean readOnly &#x3D; definition.isReadOnly();</span><br><span class="line">        if(readOnly) &#123;</span><br><span class="line">            DynamicDataSourceHolder.putDataSource(DynamicDataSourceGlobal.READ);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            DynamicDataSourceHolder.putDataSource(DynamicDataSourceGlobal.WRITE);</span><br><span class="line">        &#125;</span><br><span class="line">        super.doBegin(transaction, definition);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 清理本地线程的数据源</span><br><span class="line">     * @param transaction</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    protected void doCleanupAfterCompletion(Object transaction) &#123;</span><br><span class="line">        super.doCleanupAfterCompletion(transaction);</span><br><span class="line">        DynamicDataSourceHolder.clearDataSource();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.ibatis.executor.Executor;</span><br><span class="line">import org.apache.ibatis.executor.keygen.SelectKeyGenerator;</span><br><span class="line">import org.apache.ibatis.mapping.BoundSql;</span><br><span class="line">import org.apache.ibatis.mapping.MappedStatement;</span><br><span class="line">import org.apache.ibatis.mapping.SqlCommandType;</span><br><span class="line">import org.apache.ibatis.plugin.*;</span><br><span class="line">import org.apache.ibatis.session.ResultHandler;</span><br><span class="line">import org.apache.ibatis.session.RowBounds;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.transaction.support.TransactionSynchronizationManager;</span><br><span class="line"></span><br><span class="line">import java.util.Locale;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.Properties;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Created by IDEA</span><br><span class="line"> * User: mashaohua</span><br><span class="line"> * Date: 2016-08-10 11:09</span><br><span class="line"> * Desc:</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Intercepts(&#123;</span><br><span class="line">@Signature(type &#x3D; Executor.class, method &#x3D; &quot;update&quot;, args &#x3D; &#123;</span><br><span class="line">        MappedStatement.class, Object.class &#125;),</span><br><span class="line">@Signature(type &#x3D; Executor.class, method &#x3D; &quot;query&quot;, args &#x3D; &#123;</span><br><span class="line">        MappedStatement.class, Object.class, RowBounds.class,</span><br><span class="line">        ResultHandler.class &#125;) &#125;)</span><br><span class="line">public class DynamicPlugin implements Interceptor &#123;</span><br><span class="line"></span><br><span class="line">    protected static final Logger logger &#x3D; LoggerFactory.getLogger(DynamicPlugin.class);</span><br><span class="line"></span><br><span class="line">    private static final String REGEX &#x3D; &quot;.*insert\\u0020.*|.*delete\\u0020.*|.*update\\u0020.*&quot;;</span><br><span class="line"></span><br><span class="line">    private static final Map&lt;String, DynamicDataSourceGlobal&gt; cacheMap &#x3D; new ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object intercept(Invocation invocation) throws Throwable &#123;</span><br><span class="line"></span><br><span class="line">        boolean synchronizationActive &#x3D; TransactionSynchronizationManager.isSynchronizationActive();</span><br><span class="line">        if(!synchronizationActive) &#123;</span><br><span class="line">            Object[] objects &#x3D; invocation.getArgs();</span><br><span class="line">            MappedStatement ms &#x3D; (MappedStatement) objects[0];</span><br><span class="line"></span><br><span class="line">            DynamicDataSourceGlobal dynamicDataSourceGlobal &#x3D; null;</span><br><span class="line"></span><br><span class="line">            if((dynamicDataSourceGlobal &#x3D; cacheMap.get(ms.getId())) &#x3D;&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F;读方法</span><br><span class="line">                if(ms.getSqlCommandType().equals(SqlCommandType.SELECT)) &#123;</span><br><span class="line">                    &#x2F;&#x2F;!selectKey 为自增id查询主键(SELECT LAST_INSERT_ID() )方法，使用主库</span><br><span class="line">                    if(ms.getId().contains(SelectKeyGenerator.SELECT_KEY_SUFFIX)) &#123;</span><br><span class="line">                        dynamicDataSourceGlobal &#x3D; DynamicDataSourceGlobal.WRITE;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        BoundSql boundSql &#x3D; ms.getSqlSource().getBoundSql(objects[1]);</span><br><span class="line">                        String sql &#x3D; boundSql.getSql().toLowerCase(Locale.CHINA).replaceAll(&quot;[\\t\\n\\r]&quot;, &quot; &quot;);</span><br><span class="line">                        if(sql.matches(REGEX)) &#123;</span><br><span class="line">                            dynamicDataSourceGlobal &#x3D; DynamicDataSourceGlobal.WRITE;</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            dynamicDataSourceGlobal &#x3D; DynamicDataSourceGlobal.READ;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;else&#123;</span><br><span class="line">                    dynamicDataSourceGlobal &#x3D; DynamicDataSourceGlobal.WRITE;</span><br><span class="line">                &#125;</span><br><span class="line">                logger.warn(&quot;设置方法[&#123;&#125;] use [&#123;&#125;] Strategy, SqlCommandType [&#123;&#125;]..&quot;, ms.getId(), dynamicDataSourceGlobal.name(), ms.getSqlCommandType().name());</span><br><span class="line">                cacheMap.put(ms.getId(), dynamicDataSourceGlobal);</span><br><span class="line">            &#125;</span><br><span class="line">            DynamicDataSourceHolder.putDataSource(dynamicDataSourceGlobal);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object plugin(Object target) &#123;</span><br><span class="line">        if (target instanceof Executor) &#123;</span><br><span class="line">            return Plugin.wrap(target, this);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return target;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setProperties(Properties properties) &#123;</span><br><span class="line">        &#x2F;&#x2F;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><em>spring-db.xml</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&quot; xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot; xmlns:context&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;context&quot; xmlns:aop&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;aop&quot;</span><br><span class="line">	xmlns:tx&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;tx&quot; xmlns:mvc&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;mvc&quot;</span><br><span class="line">	xsi:schemaLocation&#x3D;&quot;</span><br><span class="line">        http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans</span><br><span class="line">        http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&#x2F;spring-beans-4.0.xsd</span><br><span class="line">        http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;aop</span><br><span class="line">        http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;aop&#x2F;spring-aop-4.0.xsd</span><br><span class="line">        http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;tx</span><br><span class="line">  http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;tx&#x2F;spring-tx-4.0.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&lt;!-- 数据库连接池 --&gt;</span><br><span class="line">	&lt;bean id&#x3D;&quot;abstractDataSource&quot; abstract&#x3D;&quot;true&quot; class&#x3D;&quot;com.alibaba.druid.pool.DruidDataSource&quot; init-method&#x3D;&quot;init&quot; destroy-method&#x3D;&quot;close&quot;&gt;</span><br><span class="line">	 	&lt;property name&#x3D;&quot;driverClassName&quot; value&#x3D;&quot;$&#123;jdbc.driver&#125;&quot;&#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;maxActive&quot; value&#x3D;&quot;$&#123;jdbc.max_active&#125;&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;initialSize&quot; value&#x3D;&quot;$&#123;jdbc.initial_size&#125;&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;maxWait&quot; value&#x3D;&quot;$&#123;jdbc.max_wait&#125;&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;minIdle&quot; value&#x3D;&quot;$&#123;jdbc.min_idle&#125;&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;timeBetweenEvictionRunsMillis&quot; value&#x3D;&quot;3000&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;minEvictableIdleTimeMillis&quot; value&#x3D;&quot;300000&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;validationQuery&quot; value&#x3D;&quot;SELECT &#39;x&#39;&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;testWhileIdle&quot; value&#x3D;&quot;true&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;testOnBorrow&quot; value&#x3D;&quot;false&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;testOnReturn&quot; value&#x3D;&quot;false&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;removeAbandoned&quot; value&#x3D;&quot;true&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;removeAbandonedTimeout&quot; value&#x3D;&quot;1800&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;logAbandoned&quot; value&#x3D;&quot;true&quot; &#x2F;&gt;</span><br><span class="line">	&lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">	&lt;bean id&#x3D;&quot;dataSourceRead&quot; parent&#x3D;&quot;abstractDataSource&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;jdbc.read.url&#125;&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;$&#123;jdbc.read.username&#125;&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;jdbc.read.password&#125;&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;dataSourceWrite&quot; parent&#x3D;&quot;abstractDataSource&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;$&#123;jdbc.url&#125;&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;$&#123;jdbc.username&#125;&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;$&#123;jdbc.password&#125;&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;dataSource&quot; class&#x3D;&quot;com.ocean.common.DynamicDataSource&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;writeDataSource&quot; ref&#x3D;&quot;dataSourceWrite&quot; &#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;readDataSource&quot; ref&#x3D;&quot;dataSourceRead&quot; &#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;defaultTargetDataSource&quot; ref&#x3D;&quot;dataSourceWrite&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id&#x3D;&quot;transactionManager&quot; class&#x3D;&quot;com.ocean.common.DynamicDataSourceTransactionManager&quot;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;dataSource&quot; ref&#x3D;&quot;dataSource&quot; &#x2F;&gt;</span><br><span class="line">	&lt;&#x2F;bean&gt;</span><br><span class="line">	&lt;tx:annotation-driven transaction-manager&#x3D;&quot;transactionManager&quot;</span><br><span class="line">		proxy-target-class&#x3D;&quot;true&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">	&lt;!-- spring和MyBatis完美整合，不需要mybatis的配置映射文件 --&gt;</span><br><span class="line">	&lt;bean id&#x3D;&quot;sqlSessionFactory&quot; class&#x3D;&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;dataSource&quot; ref&#x3D;&quot;dataSource&quot; &#x2F;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;configLocation&quot; value&#x3D;&quot;classpath:&#x2F;mybatis&#x2F;mybatis-configuration.xml&quot; &#x2F;&gt;</span><br><span class="line">		&lt;!-- 自动扫描mapping.xml文件 --&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;mapperLocations&quot; value&#x3D;&quot;classpath*:&#x2F;mybatis&#x2F;mapper&#x2F;*.xml&quot; &#x2F;&gt;</span><br><span class="line">	&lt;&#x2F;bean&gt;</span><br><span class="line">	&lt;bean class&#x3D;&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">		&lt;property name&#x3D;&quot;basePackage&quot; value&#x3D;&quot;com.ocean.dao&quot; &#x2F;&gt;</span><br><span class="line">	&lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;beans&gt;</span><br></pre></td></tr></table></figure>

<p><strong><em>mybatis-configuration.xml</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">  PUBLIC &quot;-&#x2F;&#x2F;mybatis.org&#x2F;&#x2F;DTD Config 3.0&#x2F;&#x2F;EN&quot;</span><br><span class="line">  &quot;http:&#x2F;&#x2F;mybatis.org&#x2F;dtd&#x2F;mybatis-3-config.dtd&quot;&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line"> &lt;settings&gt;</span><br><span class="line">  &lt;setting name&#x3D;&quot;cacheEnabled&quot; value&#x3D;&quot;true&quot; &#x2F;&gt;</span><br><span class="line">  &lt;setting name&#x3D;&quot;lazyLoadingEnabled&quot; value&#x3D;&quot;false&quot; &#x2F;&gt;</span><br><span class="line">  &lt;setting name&#x3D;&quot;aggressiveLazyLoading&quot; value&#x3D;&quot;false&quot; &#x2F;&gt;</span><br><span class="line">  &lt;setting name&#x3D;&quot;multipleResultSetsEnabled&quot; value&#x3D;&quot;true&quot; &#x2F;&gt;</span><br><span class="line">  &lt;setting name&#x3D;&quot;useColumnLabel&quot; value&#x3D;&quot;true&quot; &#x2F;&gt;</span><br><span class="line">  &lt;setting name&#x3D;&quot;useGeneratedKeys&quot; value&#x3D;&quot;true&quot; &#x2F;&gt;</span><br><span class="line">  &lt;setting name&#x3D;&quot;autoMappingBehavior&quot; value&#x3D;&quot;FULL&quot; &#x2F;&gt;</span><br><span class="line">  &lt;setting name&#x3D;&quot;defaultExecutorType&quot; value&#x3D;&quot;SIMPLE&quot; &#x2F;&gt;</span><br><span class="line">  &lt;setting name&#x3D;&quot;defaultStatementTimeout&quot; value&#x3D;&quot;25000&quot; &#x2F;&gt;</span><br><span class="line"> &lt;&#x2F;settings&gt;</span><br><span class="line"></span><br><span class="line"> &lt;plugins&gt;</span><br><span class="line">   &lt;plugin interceptor&#x3D;&quot;com.ocean.common.DynamicPlugin&quot;&gt;</span><br><span class="line">   &lt;&#x2F;plugin&gt;</span><br><span class="line"> &lt;&#x2F;plugins&gt;</span><br><span class="line">&lt;&#x2F;configuration&gt;</span><br></pre></td></tr></table></figure>
<p>本文转自<a href="http://www.jianshu.com/p/2222257f96d3" target="_blank" rel="noopener">http://www.jianshu.com/p/2222257f96d3</a></p>
</div><div class="post-copyright"><blockquote><p>原文作者: yapengWen</p><p>原文链接: <a href="https://yapengwen.github.io/2017/08/15/java/MyBatis/Spring+MyBatis实现数据库读写分离方案/">https://yapengwen.github.io/2017/08/15/java/MyBatis/Spring+MyBatis实现数据库读写分离方案/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/tags/MyBatis/">MyBatis</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2017/09/07/java/spring/springmvc%20%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0%E6%9D%83%E9%99%90%E6%8B%A6%E6%88%AA/" class="pre">SpringMVC 注解实现权限拦截</a><a href="/2017/08/03/git/Webhook%20%E5%AE%9E%E8%B7%B5%20%E2%80%94%E2%80%94%20%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2/" class="next">Webhook 实践 —— 自动部署</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#方案1"><span class="toc-text">方案1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#方案2"><span class="toc-text">方案2</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#方案3"><span class="toc-text">方案3</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#方案4"><span class="toc-text">方案4</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/10/04/server-machine/%E4%B8%80%E3%80%81Dell%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%80%9A%E8%BF%87%E9%9D%A2%E6%9D%BF%E4%BF%AE%E6%94%B9idrac%E5%8D%A1IP%E5%9C%B0%E5%9D%80/">一、Dell服务器通过面板修改idrac卡IP地址</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/04/server-machine/%E4%BA%8C%E3%80%81centos%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C/">一、centos设置网络</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/03/java/java-SpringCloud%E6%9E%B6%E6%9E%84/%E7%AC%AC%E5%8D%81%E4%BA%94%E7%AB%A0%E3%80%81ELK%E6%BC%94%E7%BB%83-kibana/">第十五章、ELK演练-kibana</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/02/java/java-SpringCloud%E6%9E%B6%E6%9E%84/%E7%AC%AC%E5%8D%81%E5%9B%9B%E7%AB%A0%E3%80%81ELK%E6%BC%94%E7%BB%83-logstash/">第十四章、ELK演练-logstash</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/28/java/java-SpringCloud%E6%9E%B6%E6%9E%84/%E7%AC%AC%E5%8D%81%E4%B8%89%E7%AB%A0%E3%80%81ELK%E6%BC%94%E7%BB%83-elasticSearch/">第十三章、ELK演练-elasticSearch</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/28/java/java-SpringCloud%E6%9E%B6%E6%9E%84/%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E8%B7%9F%E8%B8%AASleuth/">第十二章、分布式服务跟踪Sleuth</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/19/java/java-SpringCloud%E6%9E%B6%E6%9E%84/%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0%E3%80%81%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8/">第十一章、消息驱动</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/17/java/java-SpringCloud%E6%9E%B6%E6%9E%84/%E7%AC%AC%E5%8D%81%E7%AB%A0%E3%80%81%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BFbus/">第十章、消息总线bus</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/16/java/java-SpringCloud%E6%9E%B6%E6%9E%84/%E7%AC%AC%E4%B9%9D%E7%AB%A0%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/">第九章、分布式配置中心</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/14/java/java-SpringCloud%E6%9E%B6%E6%9E%84/%E7%AC%AC%E5%85%AB%E7%AB%A0%E3%80%81%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3/">第八章、服务网关</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IntelliJ-IDEA/">IntelliJ IDEA</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python-anaconda/">Python-anaconda</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python-base/">Python-base</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python-pandas/">Python-pandas</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/aliyun/">aliyun</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ide-eclipse/">ide-eclipse</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-DRUID/">java-DRUID</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-JVM/">java-JVM</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-MQ/">java-MQ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-MyBatis/">java-MyBatis</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-SpingBoot%E6%9E%B6%E6%9E%84/">java-SpingBoot架构</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-SpingCloud%E6%9E%B6%E6%9E%84/">java-SpingCloud架构</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-UUID/">java-UUID</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-jetty/">java-jetty</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-mail/">java-mail</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-mina/">java-mina</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-quartz/">java-quartz</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-spring/">java-spring</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-%E5%8A%A0%E8%A7%A3%E5%AF%86/">java-加解密</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">java-设计模式</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B5%81%E7%A8%8B%E5%9B%BE/">流程图</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BE%A4%E8%BE%89/">群辉</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Python%E7%AC%94%E8%AE%B0/" style="font-size: 15px;">Python笔记</a> <a href="/tags/Anaconda/" style="font-size: 15px;">Anaconda</a> <a href="/tags/Tensorflow%E7%AC%94%E8%AE%B0/" style="font-size: 15px;">Tensorflow笔记</a> <a href="/tags/aliyun/" style="font-size: 15px;">aliyun</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/GitHub/" style="font-size: 15px;">GitHub</a> <a href="/tags/IntelliJ-IDEA/" style="font-size: 15px;">IntelliJ IDEA</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/node-js/" style="font-size: 15px;">node.js</a> <a href="/tags/Markdown/" style="font-size: 15px;">Markdown</a> <a href="/tags/Atom/" style="font-size: 15px;">Atom</a> <a href="/tags/arithmetic/" style="font-size: 15px;">arithmetic</a> <a href="/tags/dell-r620/" style="font-size: 15px;">dell-r620</a> <a href="/tags/centos/" style="font-size: 15px;">centos</a> <a href="/tags/%E7%BE%A4%E8%BE%89/" style="font-size: 15px;">群辉</a> <a href="/tags/uml/" style="font-size: 15px;">uml</a> <a href="/tags/eclipse/" style="font-size: 15px;">eclipse</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Python%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8%E8%AF%A6%E8%A7%A3/" style="font-size: 15px;">Python语言入门详解</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/jprofiler/" style="font-size: 15px;">jprofiler</a> <a href="/tags/DRUID/" style="font-size: 15px;">DRUID</a> <a href="/tags/UUID/" style="font-size: 15px;">UUID</a> <a href="/tags/%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8/" style="font-size: 15px;">全局异常处理器</a> <a href="/tags/MyBatis/" style="font-size: 15px;">MyBatis</a> <a href="/tags/Assert/" style="font-size: 15px;">Assert</a> <a href="/tags/lombok/" style="font-size: 15px;">lombok</a> <a href="/tags/swagger/" style="font-size: 15px;">swagger</a> <a href="/tags/RabbitMQ/" style="font-size: 15px;">RabbitMQ</a> <a href="/tags/SpringBoot%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" style="font-size: 15px;">SpringBoot源码剖析</a> <a href="/tags/Validator/" style="font-size: 15px;">Validator</a> <a href="/tags/%E6%8E%A5%E5%8F%A3%E8%BF%94%E5%9B%9E%E5%80%BC%E7%BB%9F%E4%B8%80%E6%A0%87%E5%87%86%E6%A0%BC%E5%BC%8F/" style="font-size: 15px;">接口返回值统一标准格式</a> <a href="/tags/SpringBoot%E9%9B%86%E6%88%90mybatis/" style="font-size: 15px;">SpringBoot集成mybatis</a> <a href="/tags/SpingCloud/" style="font-size: 15px;">SpingCloud</a> <a href="/tags/Async/" style="font-size: 15px;">Async</a> <a href="/tags/elasticSearch/" style="font-size: 15px;">elasticSearch</a> <a href="/tags/kibana/" style="font-size: 15px;">kibana</a> <a href="/tags/logstash/" style="font-size: 15px;">logstash</a> <a href="/tags/jetty/" style="font-size: 15px;">jetty</a> <a href="/tags/cron/" style="font-size: 15px;">cron</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/MQ/" style="font-size: 15px;">MQ</a> <a href="/tags/%E5%8A%A0%E8%A7%A3%E5%AF%86/" style="font-size: 15px;">加解密</a> <a href="/tags/mina/" style="font-size: 15px;">mina</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 15px;">设计模式</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021</a><span class="archive-list-count">42</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">25</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/">2016</a><span class="archive-list-count">7</span></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">yapengWen.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/" target="_blank" rel="noopener"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.5"></script><div id="fullscreen-img" class="hide"><span class="close"></span></div><script type="text/javascript" src="/js/imgview.js?v=2.0.5" async></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.5" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>